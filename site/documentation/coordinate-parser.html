<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Jun 28, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20130628" />
    <meta http-equiv="Content-Language" content="en" />
    <title>CLAVIN Documentation - </title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>CLAVIN</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://beri.co" class="externalLink" title="Berico Technologies">
        Berico Technologies</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="http://github.com/Berico-Technologies/CLAVIN" class="externalLink" title="CLAVIN @ GitHub">
        CLAVIN @ GitHub</a>
        </li>
      <li class="divider ">/</li>
        <li class=""></li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 2013-06-28</li> <li class="divider pull-right">|</li>
              <li id="projectVersion" class="pull-right">Version: 0.4.0</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                            
      <li>
    
                          <a href="../index.html" title="Overview">
          <i class="none"></i>
        Overview</a>
            </li>
                  
      <li>
    
                          <a href="../roadmap.html" title="Roadmap">
          <i class="none"></i>
        Roadmap</a>
            </li>
                              <li class="nav-header">Tutorials</li>
                                
      <li>
    
                          <a href="../tutorials/installation.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                  
      <li>
    
                          <a href="../tutorials/fivemin-tutorial.html" title="5-Minute Tutorial">
          <i class="none"></i>
        5-Minute Tutorial</a>
            </li>
                              <li class="nav-header">Changelog</li>
                                
      <li>
    
                          <a href="../changelog/changes-v0.4.0.html" title="v0.4.0">
          <i class="none"></i>
        v0.4.0</a>
            </li>
                              <li class="nav-header">Documentation</li>
                                                                                              
      <li>
    
                          <a href="javascript:void(0)" title="How CLAVIN Works">
          <i class="icon-chevron-down"></i>
        How CLAVIN Works</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../documentation/model.html" title="CLAVIN's Model">
          <i class="none"></i>
        CLAVIN's Model</a>
            </li>
                      
      <li>
    
                          <a href="../documentation/workflow-tutorial.html" title="Processing Workflow">
          <i class="none"></i>
        Processing Workflow</a>
            </li>
              </ul>
        </li>
                                                                                
      <li>
    
                          <a href="javascript:void(0)" title="Building a Gazetteer Index">
          <i class="icon-chevron-down"></i>
        Building a Gazetteer Index</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../documentation/geonames-indexing.html" title="From Geonames">
          <i class="none"></i>
        From Geonames</a>
            </li>
                      
      <li>
    
                          <a href="../documentation/custom-indexing.html" title="From Custom Source">
          <i class="none"></i>
        From Custom Source</a>
            </li>
              </ul>
        </li>
                                                                                                            
      <li>
    
                          <a href="javascript:void(0)" title="Advanced Topics">
          <i class="icon-chevron-down"></i>
        Advanced Topics</a>
                    <ul class="nav nav-list">
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>Creating a Coordinate Parser</a>
          </li>
                      
      <li>
    
                          <a href="../documentation/custom-weights.html" title="Applying Custom Weights to Resolution">
          <i class="none"></i>
        Applying Custom Weights to Resolution</a>
            </li>
                      
      <li>
    
                          <a href="../documentation/multilingual.html" title="Resolving Locations in other Languages">
          <i class="none"></i>
        Resolving Locations in other Languages</a>
            </li>
              </ul>
        </li>
                              <li class="nav-header">Maven Information</li>
                                                                                                                                                                                                                                                                                                          
      <li>
    
                          <a href="../project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                                                                
      <li>
    
                          <a href="../project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                   <a href="http://maven.apache.org/" title="Maven" class="builtBy">
        <img class="builtBy"  alt="Maven" src="http://maven.apache.org/images/logos/maven-feather.png"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <div class="section"><h2>Creating a Coordinate Parser<a name="Creating_a_Coordinate_Parser"></a></h2><p>A major feature of the CLAVIN 0.4.0 release was the introduction of the extraction and reverse resolution of Coordinates. We interpret <tt>Coordinate</tt> to mean a specific geographic position on the globe represented by a set of numbers (Latitude, Longitude) or a symbol (Geohash). Since coordinates tend to have a specific schema or set of conventions for how they are used, we generally dont need natural language processing to extract them from text (a simple Regular Expression will do).</p><p>This tutorial will explain how to leverage the CLAVIN API to construct and register a new Coordinate parser. For this example, we will use a <a class="externalLink" href="http://geohash.org">GeoHash</a>, since it doesnt require any extra dependencies. Our GeoHash pattern will be quite contrived. We will expect a prefix of <b>geo:</b> followed by a string of alphanumeric characters representing the hash. Our canonical examples is <b>geo:u4pruydqqvjs</b>, which is the GeoHash mentioned on <a class="externalLink" href="http://en.wikipedia.org/wiki/Geohash">Wikipedia - GeoHash</a>.</p><p>To create a coordinate parser, you will need to create three new classes. These classes are rather trivial, so dont worry:</p>
<ol style="list-style-type: decimal">
  <li>Coordinate Model - this will symbolically represent an instance of the coordinate specific to its coordinate system.</li>
  <li>Coordinate Occurrence - this is an instance of <tt>CoordinateOccurrence</tt> specific to your custom coordinate model.</li>
  <li>Coordinate Parsing Strategy - this is a mechanism that will locate the occurrence of the coordinate in text.</li>
</ol><p>For this example, we will create the following classes:</p>
<ol style="list-style-type: decimal">
  <li><tt>GeoHash</tt> - representing a GeoHash coordinate.</li>
  <li><tt>GeoHashOccurrence</tt> - an occurrence of a <tt>GeoHash</tt> in text.</li>
  <li><tt>GeoHashParsingStrategy</tt> - a strategy for locating and parsing the <tt>GeoHash</tt> from text and returning a <tt>GeoHashOccurrence</tt>.</li>
</ol>
<blockquote><p>All of these classes can be found in the <tt>com.berico.clavin.examples</tt> package.</p>
</blockquote><div class="section"><h3>Step 1 - The <tt>GeoHash</tt> class.<a name="Step_1_-_The_GeoHash_class."></a></h3><p>The <tt>GeoHash</tt> class is very simple. It will only have one property, <tt>hashValue</tt>, which will represent the String-based Geohash. The class will also contain a method to return the <tt>LatLon</tt> value of the Geohash. <tt>LatLon</tt> is the <b>Rosetta Stone</b> of coordinates used by CLAVIN; all coordinate occurrences must be able to return a <tt>LatLon</tt> value which is used by the indexer to perform the reverse lookup.</p>
<div class="source"><pre class="prettyprint linenums">import com.berico.clavin.gazetteer.LatLon;
import com.spatial4j.core.context.SpatialContext;
import com.spatial4j.core.io.GeohashUtils;
import com.spatial4j.core.shape.Point;

public class GeoHash {

  private String hashValue;
  private LatLon latlonValue;
  
  /**
   * For serialization purposes.
   */
  public GeoHash(){}
  
  /**
   * Initialize with the GeoHash value.
   * @param hashValue GeoHash value.
   */
  public GeoHash(String hashValue){
    
    this.hashValue = hashValue;
  }

  /**
   * Get the GeoHash Value.
   * @return GeoHash Value.
   */
  public String getHashValue() {
    return hashValue;
  }
  
  /**
   * Get the LatLon Value of the GeoHash.
   * @return LatLon value.
   */
  public LatLon getLatLonValue(){
    
    if (latlonValue == null){
      
      // Spatial4J's Geohashing functionality.
      Point p = GeohashUtils.decode(this.hashValue, SpatialContext.GEO);
    
      latlonValue = new LatLon(p.getY(), p.getX());
    }
    
    return latlonValue;
  }
  
}
</pre></div></div><div class="section"><h3>Step 2 - The <tt>GeoHashOccurrence</tt> class.<a name="Step_2_-_The_GeoHashOccurrence_class."></a></h3><p>The <tt>GeoHashOccurrence</tt> class represent the finding of a <tt>GeoHash</tt> in a document. It contains a character position in text, the extracted string representing the coordinate, and the actual coordinate value. The <tt>GeoHashOccurrence</tt> class must implement the <tt>CoordinateOccurrence&lt;GeoHash&gt;</tt> interface in order to be resolved by the <tt>LocationResolver</tt>. Weve extended the abstract <tt>BaseCoordinateOccurrence</tt> class, which reduces some of the setter/getter boilerplate and directly fulfills some of the <tt>CoordinateOccurrence&lt;?&gt;</tt> requirements.</p>
<div class="source"><pre class="prettyprint linenums">import com.berico.clavin.extractor.coords.BaseCoordinateOccurrence;
import com.berico.clavin.gazetteer.LatLon;

public class GeoHashOccurrence extends BaseCoordinateOccurrence&lt;GeoHash&gt;  {
  
  /**
   * For serialization purposes.
   */
  public GeoHashOccurrence() { super(); }

  /**
   * Initialize with the GeoHash value.
   * @param position Position in document.
   * @param text Extracted GeoHash text.
   * @param value The GeoHash.
   */
  public GeoHashOccurrence(long position, String text, GeoHash value) {
    super(position, text, value);
  }

  /**
   * Get the coordinate system, in this case, &quot;geohash&quot;.
   * @return &quot;geohash&quot;
   */
  @Override
  public String getCoordinateSystem() {
    
    return &quot;geohash&quot;;
  }

  /**
   * Convert the coordinate to it's LatLon representation.
   * @return LatLon value of the coordinate.
   */
  @Override
  public LatLon convertToLatLon() {
    
    return this.value.getLatLonValue();
  }

}
</pre></div></div><div class="section"><h3>Step 3 - The <tt>GeoHashParsingStrategy</tt> class.<a name="Step_3_-_The_GeoHashParsingStrategy_class."></a></h3><p>The <tt>GeoHashParsingStrategy</tt> is a simple class that provides a REGEX pattern to a container class (<tt>RegexCoordinateExtractor</tt>), as well as, a means of extracting the coordinate from matching Strings. One additional feature we've added is support for <a class="externalLink" href="http://www.regular-expressions.info/named.html">Named Capture Groups</a> in Regular Expressions, even for versions of Java as old as 1.5 (this feature did not come into Java until version 7). We take advantage of the Named Capture Groups liberally in our implementations of the Latitude and Longitude extractors.</p><p>Another this to add is that you are given the start position and matching string. It' responsibility to return a <tt>CoordinateOccurrence</tt>, of which, these are two required pieces. The reason why we don't do this for you is to support REGEXs that may need to match larger pieces of content that include more than just the coordinate text.</p>
<div class="source"><pre class="prettyprint linenums">import java.util.Map;
import com.berico.clavin.extractor.CoordinateOccurrence;
import com.berico.clavin.extractor.coords.RegexCoordinateParsingStrategy;
import com.google.code.regexp.Pattern;

public class GeoHashParsingStrategy implements RegexCoordinateParsingStrategy&lt;GeoHash&gt; {

  public static final String GEOHASH_PATTERN = &quot;(geo[:](?&lt;hash&gt;\\w*))&quot;;
  
  /**
   * Return a compiled REGEX with the GeoHash pattern.
   * @return Compiled REGEX Pattern
   */
  @Override
  public Pattern getPattern() {
    
    return Pattern.compile(GEOHASH_PATTERN);
  }

  /**
   * Parse the GeoHash from the returned REGEX named groups, returning
   * a GeoHashOccurrence.
   * @param matchedString String matching the REGEX statement in the document.
   * @param namedGroups REGEX named capture groups.
   * @param startPosition The position the occurrence occurred in the document.
   * @return A GeoHashOccurrence.
   */
  @Override
  public CoordinateOccurrence&lt;GeoHash&gt; parse(
      String matchedString, 
      Map&lt;String, String&gt; namedGroups, 
      int startPosition) {
    
    String geohashString = namedGroups.get(&quot;hash&quot;);
    
    GeoHash geohash = new GeoHash(geohashString);
    
    return new GeoHashOccurrence(startPosition, matchedString, geohash);
  }

}
</pre></div></div><div class="section"><h3>Step 4 - Register <tt>GeoHashParsingStrategy</tt> with the <tt>GeoParserFactory</tt>.<a name="Step_4_-_Register_GeoHashParsingStrategy_with_the_GeoParserFactory."></a></h3><p>Probably the easiest way to add support for your new coordinate system is to register it with the <tt>GeoParserFactory</tt>. The <tt>GeoParserFactory</tt> provides the default configuration for a <tt>GeoParser</tt>, which can be quite complicated to instantiate with all of its dependencies.</p>
<div class="source"><pre class="prettyprint linenums">GeoParserFactory
      .DefaultCoordinateParsingStrategies
        .add(new GeoHashParsingStrategy());
</pre></div></div><div class="section"><h3>Step 5 - That's it, Perform an extraction.<a name="Step_5_-_Thats_it_Perform_an_extraction."></a></h3><p>And heres a final example of the process working (<tt>com.berico.clavin.examples.GeoHashDemo</tt>):</p>
<div class="source"><pre class="prettyprint linenums">import com.berico.clavin.GeoParser;
import com.berico.clavin.GeoParserFactory;
import com.berico.clavin.extractor.CoordinateOccurrence;
import com.berico.clavin.resolver.ResolutionContext;
import com.berico.clavin.resolver.ResolvedCoordinate;

public class GeoHashDemo {
  
  public static void main(String[] args) throws Exception {
    
    // Register the new Parsing Strategy.
    GeoParserFactory
      .DefaultCoordinateParsingStrategies
        .add(new GeoHashParsingStrategy());
    
    // Get a parser instance.
    GeoParser parser = GeoParserFactory.getDefault(&quot;IndexDirectory/&quot;);
    
    // Parse the document.
    ResolutionContext results = 
      parser.parse(&quot;Hey mom, I went to geo:u4pruydqqvjs today!&quot;);
    
    // Get the CoordinateOccurrence from the Extraction Context
    CoordinateOccurrence&lt;?&gt; ecoord = 
        results.getExtractionContext().getCoordinates().get(0);
    
    System.out.println(ecoord);
    
    // Get the ResolvedCoordinate from the results
    ResolvedCoordinate rcoord = results.getCoordinates().get(0);
    
    System.out.println(rcoord);
  }
}
</pre></div><p>And you should see the following output to the console:</p>
<div><pre>
17:24:57.836 [main] INFO  com.berico.clavin.GeoParser - Input Size: 42
17:24:57.852 [main] INFO  com.berico.clavin.GeoParser - Extracted Location Count: 0
17:24:57.858 [main] INFO  com.berico.clavin.GeoParser - Extracted Coordinates Count: 1
17:24:57.859 [main] DEBUG c.b.c.r.impl.DefaultLocationResolver - Beginning resolution step.
17:24:57.859 [main] DEBUG c.b.c.r.impl.DefaultLocationResolver - Found 0 location candidate lists.
17:24:58.400 [main] DEBUG c.b.c.r.impl.DefaultLocationResolver - Found 1 coordinate candidate lists.
New Best: 24.033824275546056, Loc: Resolved: &quot;geo:u4pruydqqvjs&quot; as 0.07398139381297736km NE of R&#xe5;bjerg Mile, [DK]
17:24:58.402 [main] DEBUG c.b.c.r.impl.DefaultLocationResolver - Selected 1 coordinates.
17:24:58.403 [main] DEBUG c.b.c.r.impl.DefaultLocationResolver - Selected 0 locations.
17:24:58.403 [main] INFO  com.berico.clavin.GeoParser - Resolved 0 locations and 1 coordinates.
com.berico.clavin.examples.GeoHashOccurrence: 
  Text: geo:u4pruydqqvjs
  Position: 19
  Value: com.berico.clavin.examples.GeoHash@79c0f654

Resolved: &quot;geo:u4pruydqqvjs&quot; as 0.07398139381297736km NE of R&#xe5;bjerg Mile, [DK]
</pre></div></div><div class="section"><h3>Step 5 - Go have another cold one!<a name="Step_5_-_Go_have_another_cold_one"></a></h3><p>Pretty easy, huh?</p></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2013
                        <a href="http://beri.co">Berico Technologies</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
